<!DOCTYPE html>
<html lang="en_US">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Canvas FP Test</title>

    <style>
      section {
          border: 1px solid gray;
          padding: 5px;
      }
    </style>
  </head>
  
  <body>
    <section>
      <h2>Outer page</h2>
      
      <p>Hash
      <p><input id="hash" type="text" size="132" disabled />

      <p>with raw URI
      <p>
        <textarea id="uri" cols="132" rows="10" disabled>
        </textarea>
    </section>

    <section>
      <h2>Same-origin iframe</h2>

      <p>Hash
      <p><input id="so-hash" type="text" size="132" disabled />

      <p>with raw URI
      <p>
        <textarea id="so-uri" cols="132" rows="10" disabled>
        </textarea>
    </section>

    <section>
      <h2>Cross-origin iframe</h2>

      <p>Hash
      <p><input id="co-hash" type="text" size="132" disabled />

      <p>with raw URI
      <p>
        <textarea id="co-uri" cols="132" rows="10" disabled>
        </textarea>
    </section>
        
    <script src="ct.js"></script>
    <script>
      console.log(`hello from outer frame at origin ${url.origin}`);

      function insertPayload(payload, source, idPfx = '') {
          console.log(`payload from ${source}`, payload);

          const { canvasDataUrl, canvasHash } = payload;
          document.getElementById(`${idPfx}hash`).value = canvasHash;
          document.getElementById(`${idPfx}uri`).value = canvasDataUrl;
      }
      
      function onMessage(e) {
          console.log('onMessage', e);
          
          const messageOrigin = e.origin;
          const idPfx = (messageOrigin === url.origin) ? 'so-' : 'co-';
          insertPayload(e.data, `iframe at origin ${messageOrigin}`, idPfx);
      }

      async function test() {
          [
              // Same origin.
              'cf.html',
              // One of these is cross origin.
              'https://joneschrisg.github.io/static/cf.html',
              'https://cjones-dev-sweatequity-cloud.s3-us-west-1.amazonaws.com/cf.html',
          ].forEach((src) => {
              console.log(`loading iframe with source ${src} ...`);
              
              const iframe = document.createElement('iframe');
              iframe.width = "0";
              iframe.height = "0";
              iframe.style.background = "transparent";
              iframe.style.border = "0";
              iframe.src = src;
              document.body.appendChild(iframe);
          });
          
          const payload = await collectCanvasFp();
          insertPayload(payload, `outer page at origin ${origin}`);
      }

      window.addEventListener('message', onMessage, false);

      test();

    </script>
  </body>
</html>
